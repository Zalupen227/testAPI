name: API Tests with Allure

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.10'

jobs:
  test:
    name: Run Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10']
      fail-fast: false

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y default-jre

    - name: Install Allure CLI
      run: |
        curl -o allure-2.24.0.tgz -L https://github.com/allure-framework/allure2/releases/download/2.24.0/allure-2.24.0.tgz
        tar -zxvf allure-2.24.0.tgz
        sudo mv allure-2.24.0 /opt/allure
        sudo ln -sf /opt/allure/bin/allure /usr/local/bin/allure

    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest-html pytest-xdist

    - name: Run API tests with Allure
      run: |
        pytest tests/ \
          -v \
          --alluredir=./allure-results \
          --junit-xml=junit-results-${{ matrix.python-version }}.xml \
          --html=report-${{ matrix.python-version }}.html \
          --self-contained-html
      continue-on-error: false

    - name: List Allure results
      if: always()
      run: |
        echo "Allure results content:"
        find ./allure-results -type f | head -20

    - name: Generate Allure report
      if: always()
      run: |
        allure generate ./allure-results \
          -o ./allure-report-${{ matrix.python-version }} \
          --clean

    - name: Upload Allure report as artifact
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: allure-report-python-${{ matrix.python-version }}
        path: allure-report-${{ matrix.python-version }}
        retention-days: 7

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-results-python-${{ matrix.python-version }}
        path: |
          allure-results
          junit-results-${{ matrix.python-version }}.xml
          report-${{ matrix.python-version }}.html
        retention-days: 7

  combine-reports:
    name: Combine Allure Reports
    runs-on: ubuntu-latest
    needs: test
    if: always()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Allure CLI
      run: |
        curl -o allure-2.24.0.tgz -L https://github.com/allure-framework/allure2/releases/download/2.24.0/allure-2.24.0.tgz
        tar -zxvf allure-2.24.0.tgz
        sudo mv allure-2.24.0 /opt/allure
        sudo ln -sf /opt/allure/bin/allure /usr/local/bin/allure

    - name: Download all test artifacts
      uses: actions/download-artifact@v3
      with:
        path: ./downloaded-artifacts

    - name: Prepare combined results
      run: |
        mkdir -p combined-allure-results
        
        # Копируем результаты из всех версий Python
        for dir in downloaded-artifacts/test-results-python-*/allure-results; do
          if [ -d "$dir" ]; then
            echo "Copying from $dir"
            cp -r "$dir"/* combined-allure-results/ 2>/dev/null || true
          fi
        done
        
        echo "Combined results content:"
        find combined-allure-results -type f | wc -l

    - name: Generate combined Allure report
      run: |
        allure generate combined-allure-results \
          -o combined-allure-report \
          --clean

    - name: Upload combined Allure report
      uses: actions/upload-artifact@v3
      with:
        name: combined-allure-report
        path: combined-allure-report
        retention-days: 30

  deploy-report:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: combine-reports
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download combined report
      uses: actions/download-artifact@v3
      with:
        name: combined-allure-report
        path: ./public

    - name: Setup Pages
      uses: actions/configure-pages@v3

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v2
      with:
        path: './public'

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2

  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: test
    if: always()

    steps:
    - name: Check test results
      run: |
        echo "=== QUALITY GATE REPORT ==="
        echo "Event: ${{ github.event_name }}"
        echo "Branch: ${{ github.ref }}"
        echo "Commit: ${{ github.sha }}"
        echo ""
        echo "Python versions tested:"
        echo "3.8: ${{ needs.test.result == 'success' && 'PASS' || 'FAIL' }}"
        echo "3.9: ${{ needs.test.result == 'success' && 'PASS' || 'FAIL' }}"
        echo "3.10: ${{ needs.test.result == 'success' && 'PASS' || 'FAIL' }}"
        echo ""
        echo "Overall status: ${{ needs.test.result }}"
        
        # Quality gate condition
        if [ "${{ needs.test.result }}" != "success" ]; then
          echo "❌ QUALITY GATE FAILED: Some tests failed"
          exit 1
        else
          echo "✅ QUALITY GATE PASSED: All tests completed successfully"
        fi

  notify:
    name: Notify Status
    runs-on: ubuntu-latest
    needs: [test, quality-gate]
    if: always()

    steps:
    - name: Notify test completion
      run: |
        echo "Tests completed for ${{ github.repository }}"
        echo "Workflow: ${{ github.workflow }}"
        echo "Result: ${{ needs.test.result }}"
        echo "Quality Gate: ${{ needs.quality-gate.result }}"
        
        # Here you can add Slack, Email, or other notifications
        # For Slack, you would use something like:
        # uses: 8398a7/action-slack@v3
        # with:
        #   status: ${{ job.status }}
        #   channel: '#ci-cd'